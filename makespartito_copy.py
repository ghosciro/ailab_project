from midiutil import MIDIFile
import os

def good_time(n): #unused
        lst=[0, 1, 2, 4, 8, 16, 32]
        return lst[min(range(len(lst)), key = lambda i: abs(lst[i] - n))]
        
#just add intervals to the note
def Magic_spartito(perception):    # note con intervalli pi√π lunghi di 8 da fixare
    
    perception = perception + [[], [], [], [], [], [], [], []]
    note_interval={"A-0":0, "A#-0":0, "B-0":0, "C-1":0, "C#-1":0, "D-1":0, "D#-1":0, "E-1":0, "F-1":0, "F#-1":0, "G-1":0, "G#-1":0, "A-1":0, "A#-1":0, "B-1":0,
            "C-2":0, "C#-2":0, "D-2":0, "D#-2":0, "E-2":0, "F-2":0, "F#-2":0, "G-2":0, "G#-2":0, "A-2":0, "A#-2":0, "B-2":0,
            "C-3":0, "C#-3":0, "D-3":0, "D#-3":0, "E-3":0, "F-3":0, "F#-3":0, "G-3":0, "G#-3":0, "A-3":0, "A#-3":0, "B-3":0,
            "C-4":0, "C#-4":0, "D-4":0, "D#-4":0, "E-4":0, "F-4":0, "F#-4":0, "G-4":0, "G#-4":0, "A-4":0, "A#-4":0, "B-4":0,
            "C-5":0, "C#-5":0, "D-5":0, "D#-5":0, "E-5":0, "F-5":0, "F#-5":0, "G-5":0, "G#-5":0, "A-5":0, "A#-5":0, "B-5":0,
            "C-6":0, "C#-6":0, "D-6":0, "D#-6":0, "E-6":0, "F-6":0, "F#-6":0, "G-6":0, "G#-6":0, "A-6":0, "A#-6":0, "B-6":0,
            "C-7":0, "C#-7":0, "D-7":0, "D#-7":0, "E-7":0, "F-7":0, "F#-7":0, "G-7":0, "G#-7":0, "A-7":0, "A#-7":0, "B-7":0, "C-8":0}

    result = [[] for i in range(len(perception))]
    repeated=set()
    c=0
    for i,note_list in enumerate(perception):
        c+=1
        if note_list or repeated:
            for note in repeated.copy():
                
                if note not in note_list :
                    result[i-note_interval[note]].append((note, note_interval[note]))  #note interval and additional time for the legature
                    note_interval[note] = 0
                    repeated.remove(note)
            for note in note_list:
                if note not in repeated:
                    repeated.add(note)
                    note_interval[note] += 1
                else:
                    note_interval[note] += 1
        else:
            result[i] = []
        if c==16:
            c=0
    #print(result)
    return result

def toMIDI(bpm, perception):
    translation= {'C-0': 0, 'C#-0': 1, 'D-0': 2, 'D#-0': 3, 'E-0': 4, 'F-0': 5, 'F#-0': 6, 'G-0': 7, 'G#-0': 8, 'A-1': 9, 'A#-1': 10, 'B-1': 11, 'C-1': 12, 'C#-1': 13, 'D-1': 14, 'D#-1': 15, 'E-1': 16, 'F-1': 17, 'F#-1': 18, 'G-1': 19, 'G#-1': 20, 'A-2': 21, 'A#-2': 22, 'B-2': 23, 'C-2': 24, 'C#-2': 25, 'D-2': 26, 'D#-2': 27, 'E-2': 28, 'F-2': 29, 'F#-2': 30, 'G-2': 31, 'G#-2': 32, 'A-3': 33, 'A#-3': 34, 'B-3': 35, 'C-3': 36, 'C#-3': 37, 'D-3': 38, 'D#-3': 39, 'E-3': 40, 'F-3': 41, 'F#-3': 42, 'G-3': 43, 'G#-3': 44, 'A-4': 45, 'A#-4': 46, 'B-4': 47, 'C-4': 48, 'C#-4': 49, 'D-4': 50, 'D#-4': 51, 'E-4': 52, 'F-4': 53, 'F#-4': 54, 'G-4': 55, 'G#-4': 56, 'A-5': 57, 'A#-5': 58, 'B-5': 59, 'C-5': 60, 'C#-5': 61, 'D-5': 62, 'D#-5': 63, 'E-5': 64, 'F-5': 65, 'F#-5': 66, 'G-5': 67, 'G#-5': 68, 'A-6': 69, 'A#-6': 70, 'B-6': 71, 'C-6': 72, 'C#-6': 73, 'D-6': 74, 'D#-6': 75, 'E-6': 76, 'F-6': 77, 'F#-6': 78, 'G-6': 79, 'G#-6': 80, 'A-7': 81, 'A#-7': 82, 'B-7': 83, 'C-7': 84, 'C#-7': 85, 'D-7': 86, 'D#-7': 87, 'E-7': 88, 'F-7': 89, 'F#-7': 90, 'G-7': 91, 'G#-7': 92, 'A-8': 93, 'A#-8': 94, 'B-8': 95, 'C-8': 96, 'C#-8': 97, 'D-8': 98, 'D#-8': 99, 'E-8': 100, 'F-8': 101, 'F#-8': 102, 'G-8': 103, 'G#-8': 104, 'A-9': 105, 'A#-9': 106, 'B-9': 107, 'C-9': 108, 'C#-9': 109, 'D-9': 110, 'D#-9': 111, 'E-9': 112, 'F-9': 113, 'F#-9': 114, 'G-9': 115, 'G#-9': 116, 'A-10': 117, 'A#-10': 118, 'B-10': 119, 'C-10': 120, 'C#-10': 121, 'D-10': 122, 'D#-10': 123, 'E-10': 124, 'F-10': 125, 'F#-10': 126, 'G-10': 127}
    magic_spartito=Magic_spartito(perception)
    midi = MIDIFile(1)
    midi.addTempo(0, 4, bpm)
    time=0
    for note_list in magic_spartito:
        
        for note in note_list:
            midi.addNote(0, 0, translation[note[0]], time, note[1]/4, 100) #note[1]/4 for 1/8 #note[1]/8 for 1/32
        time += 0.25 #for 1/16
        #time += 0.03125 #for 1/32
    with open("./spartito.mid", "wb") as file:
        midi.writeFile(file)
    os.system('cmd /c "MidiSheetMusic-2.6.2.exe spartito.mid"')
    return


    



#toMIDI(138, [{'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}, {'F-4', 'C#-5', 'G#-4'}])

